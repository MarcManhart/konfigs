---
# NVIDIA Driver Role

- name: Install NVIDIA drivers (Arch)
  when: ansible_distribution == "Archlinux"
  block:
    - name: Install NVIDIA packages
      community.general.pacman:
        name:
          - nvidia
          - nvidia-utils
          - lib32-nvidia-utils
          - nvidia-settings
          - opencl-nvidia
          - lib32-opencl-nvidia
          - libva-nvidia-driver
          - vulkan-icd-loader
          - lib32-vulkan-icd-loader
        state: present

    - name: Install NVIDIA tools
      community.general.pacman:
        name:
          - mesa-demos
          - vulkan-tools
          - libva-utils
          - vdpauinfo
        state: present

- name: Install NVIDIA drivers (Debian/Ubuntu)
  when: ansible_os_family == "Debian"
  block:
    - name: Install NVIDIA packages
      ansible.builtin.apt:
        name:
          - nvidia-driver
          - nvidia-settings
          - nvidia-vaapi-driver
          - libnvidia-gl-535  # Version anpassen
          - libnvidia-gl-535:i386
          - vulkan-tools
          - mesa-utils
          - vainfo
          - vdpauinfo
        state: present
      ignore_errors: true

- name: Install NVIDIA drivers (Fedora)
  when: ansible_distribution == "Fedora"
  block:
    - name: Enable RPM Fusion NVIDIA
      ansible.builtin.dnf:
        name:
          - akmod-nvidia
          - xorg-x11-drv-nvidia
          - xorg-x11-drv-nvidia-cuda
          - nvidia-vaapi-driver
          - vulkan-tools
          - mesa-demos
        state: present

# Kernel Parameters
- name: Configure GRUB with NVIDIA parameters (Debian/Ubuntu)
  when: ansible_os_family == "Debian"
  block:
    - name: Add kernel parameters to GRUB
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        regexp: "^GRUB_CMDLINE_LINUX_DEFAULT="
        line: 'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash {{ nvidia_kernel_params | join(" ") }}"'
      notify: Update GRUB

- name: Configure kernel parameters (Arch)
  when: ansible_distribution == "Archlinux"
  block:
    - name: Create mkinitcpio hook for nvidia
      ansible.builtin.copy:
        content: |
          [Trigger]
          Operation=Install
          Operation=Upgrade
          Operation=Remove
          Type=Package
          Target=nvidia
          Target=linux
          Target=linux-lts

          [Action]
          Description=Update Nvidia module in initcpio
          Depends=mkinitcpio
          When=PostTransaction
          NeedsTargets
          Exec=/bin/sh -c 'while read -r trg; do case $trg in linux*) exit 0; esac; done; /usr/bin/mkinitcpio -P'
        dest: /etc/pacman.d/hooks/nvidia.hook
        mode: '0644'

    - name: Add NVIDIA modules to mkinitcpio
      ansible.builtin.lineinfile:
        path: /etc/mkinitcpio.conf
        regexp: "^MODULES="
        line: 'MODULES=(nvidia nvidia_modeset nvidia_uvm nvidia_drm)'
      notify: Rebuild initramfs

# Environment Variables
- name: Set NVIDIA environment variables
  ansible.builtin.blockinfile:
    path: /etc/environment
    block: |
      LIBVA_DRIVER_NAME=nvidia
      VDPAU_DRIVER=nvidia
      __GLX_VENDOR_LIBRARY_NAME=nvidia
      GBM_BACKEND=nvidia-drm
    marker: "# {mark} ANSIBLE NVIDIA MANAGED BLOCK"
    create: true
    mode: '0644'

# Modprobe configuration
- name: Configure NVIDIA modules
  ansible.builtin.copy:
    content: |
      options nvidia-drm modeset=1
      options nvidia NVreg_PreserveVideoMemoryAllocations=1
    dest: /etc/modprobe.d/nvidia.conf
    mode: '0644'

# Power management
- name: Enable NVIDIA power management services (Arch)
  when:
    - ansible_distribution == "Archlinux"
    - nvidia_power_management
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
  loop:
    - nvidia-suspend
    - nvidia-hibernate
    - nvidia-resume
  ignore_errors: true

# X11 Configuration f√ºr Coolbits (Fan Control etc.)
- name: Create NVIDIA X11 configuration
  ansible.builtin.copy:
    content: |
      Section "Device"
          Identifier     "Device0"
          Driver         "nvidia"
          VendorName     "NVIDIA Corporation"
          Option         "Coolbits" "4"
      EndSection
    dest: /etc/X11/xorg.conf.d/20-nvidia.conf
    mode: '0644'
  ignore_errors: true
