---
# Dotfiles Role - Links dotfiles from repository

- name: Set dotfiles paths
  ansible.builtin.set_fact:
    dotfiles_src: "{{ dotfiles_dir }}"
    resources_src: "{{ resources_dir }}"
    target_home: "{{ dotfiles_home }}"

- name: Debug paths
  ansible.builtin.debug:
    msg: |
      Dotfiles source: {{ dotfiles_src }}
      Resources source: {{ resources_src }}
      Target home: {{ target_home }}

# Create necessary directories
- name: Create config directories
  ansible.builtin.file:
    path: "{{ target_home }}/{{ item }}"
    state: directory
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    mode: '0755'
  loop:
    - .config
    - .config/nvim
    - .config/hypr
    - .config/waybar
    - .config/conky
    - .config/copyq
    - .config/terminator
    - .config/godot
    - .config/gtk-4.0
    - .config/blender/{{ blender_version }}/config
    - .config/blender/{{ blender_version }}/scripts/presets/interface_theme
    - .config/blender/{{ blender_version }}/scripts/addons
    - .claude
    - .mplayer
    - .themes

# Backup and link dotfiles
- name: Link dotfiles
  ansible.builtin.include_tasks: link_file.yml
  loop: "{{ dotfiles_links }}"
  loop_control:
    loop_var: dotfile
  vars:
    src_base: "{{ dotfiles_src }}"

# Link resources (themes, etc.)
- name: Link resources
  ansible.builtin.include_tasks: link_file.yml
  loop: "{{ resource_links }}"
  loop_control:
    loop_var: dotfile
  vars:
    src_base: "{{ resources_src }}"

# Blender config
- name: Link Blender config
  ansible.builtin.file:
    src: "{{ dotfiles_src }}/.config/blender/{{ blender_version }}/config"
    dest: "{{ target_home }}/.config/blender/{{ blender_version }}/config"
    state: link
    force: true
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
  ignore_errors: true

# Blender theme
- name: Link Blender Gruvbox theme
  ansible.builtin.file:
    src: "{{ resources_src }}/styling/Themes/Blender/theme-gruvbox-dark-v1.5.0/Gruvbox_Dark.xml"
    dest: "{{ target_home }}/.config/blender/{{ blender_version }}/scripts/presets/interface_theme/Gruvbox_Dark.xml"
    state: link
    force: true
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
  ignore_errors: true

# Blender addon
- name: Link Blender quick_mesh_rename addon
  ansible.builtin.file:
    src: "{{ resources_src }}/blender_extensions/quick_mesh_rename.py"
    dest: "{{ target_home }}/.config/blender/{{ blender_version }}/scripts/addons/quick_mesh_rename.py"
    state: link
    force: true
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
  ignore_errors: true

# Set correct ownership
- name: Ensure correct ownership of home directory
  ansible.builtin.file:
    path: "{{ target_home }}"
    owner: "{{ dotfiles_user }}"
    group: "{{ dotfiles_user }}"
    recurse: true
  changed_when: false
