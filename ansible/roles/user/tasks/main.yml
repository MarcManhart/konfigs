---
# User Role - Benutzer-Setup

- name: Create main user
  ansible.builtin.user:
    name: "{{ main_user }}"
    comment: "{{ main_user_comment | default(main_user) }}"
    shell: "{{ main_user_shell }}"
    groups: "{{ main_user_groups }}"
    append: true
    create_home: true
    state: present

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "/home/{{ main_user }}/.ssh"
    state: directory
    owner: "{{ main_user }}"
    group: "{{ main_user }}"
    mode: '0700'

- name: Add SSH authorized keys
  ansible.posix.authorized_key:
    user: "{{ main_user }}"
    key: "{{ item }}"
    state: present
  loop: "{{ main_user_ssh_keys }}"
  when: main_user_ssh_keys | length > 0

- name: Configure sudoers for wheel group
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: "^%wheel"
    line: "%wheel ALL=(ALL:ALL) ALL"
    validate: "visudo -cf %s"

# Install user-specific packages
- name: Install user packages (Arch)
  when: ansible_distribution == "Archlinux"
  block:
    - name: Install from official repos
      community.general.pacman:
        name:
          - discord
          - obs-studio
          - veracrypt
          - lazygit
        state: present

    # AUR packages would need yay/paru
    - name: Check if yay is installed
      ansible.builtin.command: which yay
      register: yay_check
      changed_when: false
      failed_when: false

    - name: Install AUR packages with yay
      become: true
      become_user: "{{ main_user }}"
      ansible.builtin.command:
        cmd: "yay -S --noconfirm {{ item }}"
      loop:
        - spotify
        - 1password
        - 1password-cli
        - slack-desktop
      when: yay_check.rc == 0
      changed_when: true
      failed_when: false

- name: Install user packages (Debian/Ubuntu)
  when: ansible_os_family == "Debian"
  block:
    - name: Install common packages
      ansible.builtin.apt:
        name:
          - vlc
          - obs-studio
          - veracrypt
        state: present

    # Spotify repo
    - name: Add Spotify GPG key
      ansible.builtin.apt_key:
        url: https://download.spotify.com/debian/pubkey_6224F9941A8AA6D1.gpg
        state: present

    - name: Add Spotify repository
      ansible.builtin.apt_repository:
        repo: "deb http://repository.spotify.com stable non-free"
        state: present

    - name: Install Spotify
      ansible.builtin.apt:
        name: spotify-client
        state: present
        update_cache: true

- name: Install user packages (Fedora)
  when: ansible_distribution == "Fedora"
  block:
    - name: Enable RPM Fusion
      ansible.builtin.dnf:
        name:
          - "https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ ansible_distribution_major_version }}.noarch.rpm"
          - "https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ ansible_distribution_major_version }}.noarch.rpm"
        state: present
        disable_gpg_check: true

    - name: Install user packages
      ansible.builtin.dnf:
        name:
          - discord
          - obs-studio
          - vlc
        state: present

# v4l2loopback f√ºr OBS Virtual Camera
- name: Install v4l2loopback
  ansible.builtin.package:
    name: "{{ 'v4l2loopback-dkms' if ansible_os_family == 'Debian' else 'v4l2loopback' }}"
    state: present
  ignore_errors: true

- name: Configure v4l2loopback
  ansible.builtin.copy:
    content: |
      options v4l2loopback devices=1 video_nr=10 card_label="OBS Virtual Camera" exclusive_caps=1
    dest: /etc/modprobe.d/v4l2loopback.conf
    mode: '0644'
