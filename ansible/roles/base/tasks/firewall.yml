---
# Firewall Konfiguration

# UFW für Debian/Ubuntu
- name: Configure UFW (Debian/Ubuntu)
  when: ansible_os_family == "Debian"
  block:
    - name: Install ufw
      ansible.builtin.apt:
        name: ufw
        state: present

    - name: Set UFW default policies
      community.general.ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: incoming, policy: deny }
        - { direction: outgoing, policy: allow }

    - name: Allow SSH
      community.general.ufw:
        rule: allow
        port: "22"
        proto: tcp

    - name: Enable UFW
      community.general.ufw:
        state: enabled

# Firewalld für Fedora
- name: Configure firewalld (Fedora)
  when: ansible_distribution == "Fedora"
  block:
    - name: Ensure firewalld is running
      ansible.builtin.systemd:
        name: firewalld
        enabled: true
        state: started

    - name: Allow SSH in firewalld
      ansible.posix.firewalld:
        service: ssh
        permanent: true
        state: enabled
        immediate: true

# iptables für Arch (oder nftables)
- name: Configure iptables (Arch)
  when: ansible_distribution == "Archlinux"
  block:
    - name: Install iptables
      community.general.pacman:
        name: iptables
        state: present

    - name: Allow established connections
      ansible.builtin.iptables:
        chain: INPUT
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT

    - name: Allow SSH
      ansible.builtin.iptables:
        chain: INPUT
        protocol: tcp
        destination_port: "22"
        jump: ACCEPT

    - name: Set default INPUT policy
      ansible.builtin.iptables:
        chain: INPUT
        policy: DROP

    - name: Save iptables rules
      ansible.builtin.shell: iptables-save > /etc/iptables/iptables.rules
      changed_when: true

    - name: Enable iptables service
      ansible.builtin.systemd:
        name: iptables
        enabled: true
        state: started
