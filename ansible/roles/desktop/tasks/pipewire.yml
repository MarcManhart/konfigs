---
# PipeWire Audio Setup

- name: Install PipeWire (Arch)
  when: ansible_distribution == "Archlinux"
  community.general.pacman:
    name:
      - pipewire
      - pipewire-alsa
      - pipewire-pulse
      - pipewire-jack
      - wireplumber
      - pavucontrol
    state: present

- name: Install PipeWire (Debian/Ubuntu)
  when: ansible_os_family == "Debian"
  ansible.builtin.apt:
    name:
      - pipewire
      - pipewire-pulse
      - pipewire-alsa
      - wireplumber
      - pavucontrol
    state: present

- name: Install PipeWire (Fedora)
  when: ansible_distribution == "Fedora"
  ansible.builtin.dnf:
    name:
      - pipewire
      - pipewire-pulseaudio
      - pipewire-alsa
      - wireplumber
      - pavucontrol
    state: present

- name: Enable PipeWire user services
  become: true
  become_user: "{{ main_user }}"
  ansible.builtin.systemd:
    name: "{{ item }}"
    scope: user
    enabled: true
    state: started
  loop:
    - pipewire
    - pipewire-pulse
    - wireplumber
  ignore_errors: true

# Low-latency config f√ºr Gaming
- name: Create PipeWire config directory
  ansible.builtin.file:
    path: /etc/pipewire/pipewire.conf.d
    state: directory
    mode: '0755'

- name: Configure low-latency audio
  ansible.builtin.copy:
    content: |
      context.properties = {
          default.clock.rate = 48000
          default.clock.quantum = 512
          default.clock.min-quantum = 512
          default.clock.max-quantum = 512
      }
    dest: /etc/pipewire/pipewire.conf.d/92-low-latency.conf
    mode: '0644'
