---
# Playbook für CachyOS Test-VM
# Vollständige Konfiguration ohne NVIDIA (da VM)

- name: Configure CachyOS VM
  hosts: cachyos
  become: true

  pre_tasks:
    - name: Detect distribution
      ansible.builtin.setup:
        filter: ansible_distribution*

    - name: Display target system info
      ansible.builtin.debug:
        msg: |
          Target: {{ inventory_hostname }}
          Distribution: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Architecture: {{ ansible_architecture }}

    - name: Verify CachyOS (Arch-based)
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Archlinux" or ansible_os_family == "Archlinux"
        fail_msg: "This playbook is designed for CachyOS/Arch-based systems"
      ignore_errors: true

  roles:
    # Basis-System (Locale, Pakete, SSH, Firewall)
    - role: base
      tags: [base, always]

    # User-Setup
    - role: user
      tags: [user]

    # Desktop-Umgebung Basis (GDM, Printing, Audio)
    - role: desktop
      tags: [desktop]

    # GNOME Desktop
    - role: gnome
      when: enable_gnome | default(true)
      tags: [gnome, desktop]

    # Hyprland (Wayland WM)
    - role: hyprland
      when: enable_hyprland | default(true)
      tags: [hyprland, desktop]

    # Gaming (Steam, Emulators, Controller)
    - role: gaming
      when: enable_gaming | default(true)
      tags: [gaming]

    # Dotfiles verlinken (als letztes)
    - role: dotfiles
      tags: [dotfiles]

  post_tasks:
    # VM-spezifische Pakete
    - name: Install VM guest tools
      community.general.pacman:
        name:
          - spice-vdagent
          - qemu-guest-agent
        state: present
      when: extra_packages is defined

    - name: Enable VM guest services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - spice-vdagentd
        - qemu-guest-agent
      ignore_errors: true

    - name: Final message
      ansible.builtin.debug:
        msg: |
          ========================================
          Configuration complete for {{ inventory_hostname }}!

          CachyOS VM Setup:
          - NVIDIA: disabled (VM)
          - GNOME: {{ enable_gnome | default(true) }}
          - Hyprland: {{ enable_hyprland | default(true) }}
          - Gaming: {{ enable_gaming | default(true) }}

          Next steps:
          - Reboot the VM
          - Log in as {{ main_user }}
          ========================================
