---
# Ansible Playbook für Bunte (ASUS ROG Zephyrus G16 2025)
# Entspricht dem NixOS-Profil: base + desktop + hyprland + gnome + container + gaming + i2p + mauschel + home-manager
#
# Unterstützt: Arch/CachyOS, Debian/Ubuntu/Pop!_OS, Fedora
# Ausführen mit: ansible-playbook -i inventory playbook.yml --ask-become-pass --limit <host>
#
# Voraussetzung: Das konfigs-Repo muss unter ~/konfigs ausgecheckt sein.

- name: Bunte Setup
  hosts: Bunte
  become: true
  vars:
    user: mauschel
    user_home: "/home/{{ user }}"
    konfigs_dir: "{{ user_home }}/konfigs"
    dot: "{{ konfigs_dir }}/dotfiles"
    styles: "{{ konfigs_dir }}/resources/styling"
    blender_version: "4.4"

    # ══════════════════════════════════════════════════════════════
    # Pakete mit gleichem Namen auf allen Distros
    # ══════════════════════════════════════════════════════════════
    common_packages:
      - vim
      - git
      - vlc
      - htop
      - curl
      - wget
      - jq
      - tree
      - zip
      - unzip
      - zsh
      - flatpak
      - firefox
      - thunderbird
      - blender
      - inkscape
      - krita
      - scribus
      - mplayer
      - openvpn
      - conky
      - direnv
      - syncthing
      - docker
      - docker-compose
      - chromium
      - parted
      - clamav
      - brightnessctl
      - nvtop
      - kitty
      - waybar
      - blueman
      - grim
      - slurp
      - obs-studio
      - ffmpeg
      - ripgrep
      - xclip
      - neovim

    # ══════════════════════════════════════════════════════════════
    # Distro-spezifische Paketnamen
    # ══════════════════════════════════════════════════════════════
    base_packages:
      Archlinux:
        - python
        - git-lfs
        - nodejs
        - 7zip
        - openssh
        - networkmanager
        - firewalld
        - pipewire
        - pipewire-alsa
        - pipewire-pulse
        - wireplumber
        - cups
        - cups-filters
        - gutenprint
        - hplip
        - avahi
        - nss-mdns
        - bluez
        - bluez-utils
        - solaar
        - libvirt
        - virt-manager
        - qemu-desktop
        - dnsmasq
        - copyq
        - terminator
        - libreoffice-fresh
        - tor
        - torbrowser-launcher
        - android-tools
        - libratbag
        - i2pd
        - discord
        - veracrypt
        - go
        - starship
        - lazygit
        - cava
        - pnpm
        - dotnet-sdk
        - sassc
        - gnome-themes-extra
        - hyprland
        - hyprpaper
        - network-manager-applet
        - rofi
        - polkit-gnome
        - xdg-desktop-portal-hyprland
        - xdg-desktop-portal-gtk
        - wl-clipboard
        - hypridle
        - hyprlock
        - swappy
        - wdisplays
        - gnome
        - gnome-tweaks
        - gdm
        - networkmanager-openvpn
        - dive
        - steam
        - mangohud
        - lib32-mangohud
        - gamemode
        - lib32-gamemode
        - gamescope
        - goverlay
        - wine-staging
        - winetricks
        - mupen64plus
        - retroarch
        - retroarch-assets-xmb
        - vulkan-tools
        - vulkan-icd-loader
        - lib32-vulkan-icd-loader
        - vulkan-validation-layers
        - antimicrox
        - v4l2loopback-dkms
        - mesa-demos
        - libva-utils
        - alsa-utils
        - ddcutil
        - gstreamer
        - gst-plugins-base
        - gst-plugins-good
        - gst-plugins-bad
        - gst-plugins-ugly
        - gst-libav
        - gstreamer-vaapi
        - nvidia-open
        - nvidia-utils
        - lib32-nvidia-utils
        - nvidia-settings
        - ttf-nerd-fonts-symbols
        - ttf-firacode-nerd
        - ttf-jetbrains-mono-nerd
        - ttf-hack-nerd
        - thermald
        # GNOME Extensions
        - gnome-shell-extension-appindicator
        - gnome-shell-extension-dash-to-dock

      Debian:
        - python3
        - git-lfs
        - nodejs
        - p7zip-full
        - openssh-server
        - network-manager
        - ufw
        - pipewire
        - pipewire-alsa
        - pipewire-pulse
        - wireplumber
        - cups
        - printer-driver-gutenprint
        - hplip
        - avahi-daemon
        - libnss-mdns
        - bluetooth
        - bluez
        - solaar
        - libvirt-daemon-system
        - virt-manager
        - qemu-system-x86
        - dnsmasq-base
        - copyq
        - terminator
        - libreoffice
        - torbrowser-launcher
        - adb
        - i2pd
        - veracrypt
        - golang
        - sassc
        - gnome-themes-extra
        - gtk2-engines-murrine
        - hyprland
        - hyprpaper
        - network-manager-gnome
        - rofi
        - policykit-1-gnome
        - xdg-desktop-portal-hyprland
        - xdg-desktop-portal-gtk
        - wl-clipboard
        - swappy
        - wdisplays
        - gnome-core
        - gnome-tweaks
        - gdm3
        - network-manager-openvpn-gnome
        - steam-installer
        - mangohud
        - gamemode
        - gamescope
        - wine
        - winetricks
        - retroarch
        - vulkan-tools
        - libvulkan1
        - vulkan-validationlayers
        - antimicrox
        - v4l2loopback-dkms
        - mesa-utils
        - vainfo
        - alsa-utils
        - ddcutil
        - gstreamer1.0-plugins-base
        - gstreamer1.0-plugins-good
        - gstreamer1.0-plugins-bad
        - gstreamer1.0-plugins-ugly
        - gstreamer1.0-libav
        - gstreamer1.0-vaapi
        - nvidia-driver
        - nvidia-settings
        - fonts-firacode
        - fonts-hack
        - thermald
        - ttf-mscorefonts-installer
        # GNOME Extensions
        - gnome-shell-extension-appindicator
        - gnome-shell-extension-dash-to-dock
        - gnome-shell-extension-gsconnect

      RedHat:
        - python3
        - git-lfs
        - nodejs
        - p7zip
        - openssh-server
        - NetworkManager
        - firewalld
        - pipewire
        - pipewire-alsa
        - pipewire-pulseaudio
        - wireplumber
        - cups
        - gutenprint
        - hplip
        - avahi
        - nss-mdns
        - bluez
        - solaar
        - libvirt
        - virt-manager
        - qemu-kvm
        - dnsmasq
        - copyq
        - terminator
        - libreoffice
        - android-tools
        - i2pd
        - veracrypt
        - golang
        - sassc
        - gnome-themes-extra
        - gtk-murrine-engine
        - hyprland
        - network-manager-applet
        - rofi-wayland
        - polkit-gnome
        - xdg-desktop-portal-hyprland
        - xdg-desktop-portal-gtk
        - wl-clipboard
        - swappy
        - gnome-shell
        - gnome-tweaks
        - gdm
        - NetworkManager-openvpn-gnome
        - steam
        - mangohud
        - gamemode
        - gamescope
        - wine
        - winetricks
        - retroarch
        - vulkan-tools
        - vulkan-loader
        - vulkan-validation-layers
        - v4l2loopback
        - mesa-demos
        - libva-utils
        - alsa-utils
        - ddcutil
        - gstreamer1-plugins-base
        - gstreamer1-plugins-good
        - gstreamer1-plugins-bad-free
        - gstreamer1-plugins-ugly-free
        - gstreamer1-libav
        - gstreamer1-vaapi
        - akmod-nvidia
        - xorg-x11-drv-nvidia
        - nvidia-settings
        - fira-code-fonts
        - thermald
        # GNOME Extensions
        - gnome-shell-extension-appindicator
        - gnome-shell-extension-dash-to-dock
        - gnome-shell-extension-gsconnect

    # ══════════════════════════════════════════════════════════════
    # Flatpak-Apps (distro-unabhängig)
    # ══════════════════════════════════════════════════════════════
    flatpak_apps:
      - com.brave.Browser
      - com.visualstudio.code
      - md.obsidian.Obsidian
      - org.onlyoffice.desktopeditors
      - com.onepassword.OnePassword
      - com.spotify.Client
      - nz.mega.MEGAsync
      - com.slack.Slack
      - org.localsend.localsend_app
      - net.lutris.Lutris
      - com.usebottles.bottles
      - com.usebruno.Bruno
      - com.github.tchx84.Flatseal
      - net.davidotek.pupgui2          # ProtonUp-Qt
      - org.libretro.RetroArch
      - net.pcsx2.PCSX2
      - com.discordapp.Discord
      - org.godotengine.GodotSharp     # Godot Mono
      - org.libreoffice.LibreOffice
      - com.github.ADBeveridge.Raider  # Tor Browser

    # ══════════════════════════════════════════════════════════════
    # Dotfiles Symlinks (aus home.nix home.file.*)
    # ══════════════════════════════════════════════════════════════
    dotfile_links:
      - { src: ".config/terminator/config",  dest: ".config/terminator/config" }
      - { src: ".vimrc",                     dest: ".vimrc" }
      - { src: ".zshrc",                     dest: ".zshrc" }
      - { src: ".mplayer/config",            dest: ".mplayer/config" }
      - { src: ".config/nvim/init.lua",      dest: ".config/nvim/init.lua" }
      - { src: ".config/hypr/hyprland.conf", dest: ".config/hypr/hyprland.conf" }
      - { src: ".config/hypr/hyprpaper.conf", dest: ".config/hypr/hyprpaper.conf" }
      - { src: ".config/waybar/power_menu.xml", dest: ".config/waybar/power_menu.xml" }
      - { src: ".config/waybar/config.jsonc", dest: ".config/waybar/config.jsonc" }
      - { src: ".config/waybar/style.css",   dest: ".config/waybar/style.css" }
      - { src: ".config/starship.toml",      dest: ".config/starship.toml" }
      - { src: ".config/conky/conky.conf",   dest: ".config/conky/conky.conf" }
      - { src: ".config/copyq/copyq.conf",   dest: ".config/copyq/copyq.conf" }
      - { src: ".config/copyq/copyq-commands.ini", dest: ".config/copyq/copyq-commands.ini" }
      - { src: ".config/copyq/copyq_tabs.ini", dest: ".config/copyq/copyq_tabs.ini" }
      - { src: ".claude/settings.json",      dest: ".claude/settings.json" }
      - { src: ".config/kritarc",            dest: ".config/kritarc" }
      - { src: ".config/godot/editor_settings-4.4.tres", dest: ".config/godot/editor_settings-4.4.tres" }

    # Blender Dotfiles (mit Version-Variable)
    blender_dotfile_links:
      - { src: ".config/blender/{{ blender_version }}/config", dest: ".config/blender/{{ blender_version }}/config" }

    # Styling/Theme Symlinks (aus resources/styling)
    styling_links:
      - src: "Themes/Gruvbox-Dark-BL-LB/Gruvbox-Dark"
        dest: ".themes/Gruvbox-Dark"
      - src: "Themes/Gruvbox-Dark-BL-LB/Gruvbox-Dark/gtk-4.0/assets"
        dest: ".config/gtk-4.0/assets"
      - src: "Themes/Gruvbox-Dark-BL-LB/Gruvbox-Dark/gtk-4.0/gtk.css"
        dest: ".config/gtk-4.0/gtk.css"
      - src: "Themes/Gruvbox-Dark-BL-LB/Gruvbox-Dark/gtk-4.0/gtk-dark.css"
        dest: ".config/gtk-4.0/gtk-dark.css"

    # Blender Theme + Addon aus resources
    blender_extra_links:
      - src: "{{ styles }}/Themes/Blender/theme-gruvbox-dark-v1.5.0/Gruvbox_Dark.xml"
        dest: ".config/blender/{{ blender_version }}/scripts/presets/interface_theme/Gruvbox_Dark.xml"
      - src: "{{ konfigs_dir }}/resources/blender_extensions/quick_mesh_rename.py"
        dest: ".config/blender/{{ blender_version }}/scripts/addons/quick_mesh_rename.py"

  tasks:
    # ══════════════════════════════════════════════════════════════
    # Locale & Timezone (base.nix)
    # ══════════════════════════════════════════════════════════════
    - name: Locale auf de_DE.UTF-8 setzen
      locale_gen:
        name: de_DE.UTF-8
        state: present
      when: ansible_os_family == "Debian"

    - name: Timezone auf Europe/Berlin setzen
      timezone:
        name: Europe/Berlin

    # ══════════════════════════════════════════════════════════════
    # Voraussetzungen
    # ══════════════════════════════════════════════════════════════
    - name: Paketcache aktualisieren (Debian)
      apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Prüfen ob Multilib bereits aktiv ist (Arch)
      command: grep -q '^\[multilib\]' /etc/pacman.conf
      register: multilib_check
      changed_when: false
      failed_when: false
      when: ansible_os_family == "Archlinux"

    - name: Multilib aktivieren (Arch)
      blockinfile:
        path: /etc/pacman.conf
        marker: "# {mark} ANSIBLE MANAGED - multilib"
        block: |
          [multilib]
          Include = /etc/pacman.d/mirrorlist
      when: ansible_os_family == "Archlinux" and multilib_check.rc != 0
      register: multilib_result

    - name: Paketcache aktualisieren (Arch)
      pacman:
        update_cache: true
      when: ansible_os_family == "Archlinux" and multilib_result is changed

    - name: RPM Fusion aktivieren (Fedora)
      dnf:
        name:
          - "https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ ansible_distribution_major_version }}.noarch.rpm"
          - "https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ ansible_distribution_major_version }}.noarch.rpm"
        state: present
        disable_gpg_check: true
      when: ansible_os_family == "RedHat"

    - name: i386-Architektur hinzufügen (Debian)
      command: dpkg --add-architecture i386
      changed_when: false
      when: ansible_os_family == "Debian"

    # ══════════════════════════════════════════════════════════════
    # Pakete installieren
    # ══════════════════════════════════════════════════════════════
    - name: Gemeinsame Pakete installieren
      package:
        name: "{{ common_packages }}"
        state: present

    - name: Distro-spezifische Pakete installieren
      package:
        name: "{{ base_packages[ansible_os_family] }}"
        state: present
      when: ansible_os_family in base_packages

    # ══════════════════════════════════════════════════════════════
    # Flatpak (proprietäre / cross-distro Apps)
    # ══════════════════════════════════════════════════════════════
    - name: Flatpak installieren
      package:
        name: flatpak
        state: present

    - name: Flathub Remote hinzufügen
      community.general.flatpak_remote:
        name: flathub
        flatpakrepo_url: https://dl.flathub.org/repo/flathub.flatpakrepo
        state: present

    - name: Flatpak-Apps installieren
      community.general.flatpak:
        name: "{{ item }}"
        state: present
        remote: flathub
      loop: "{{ flatpak_apps }}"

    # ══════════════════════════════════════════════════════════════
    # Benutzer & Shell (base.nix + home.nix)
    # ══════════════════════════════════════════════════════════════
    - name: Zsh als Standard-Shell setzen
      user:
        name: "{{ user }}"
        shell: /usr/bin/zsh

    - name: User-Gruppen setzen
      user:
        name: "{{ user }}"
        groups:
          - wheel
          - docker
          - video
          - audio
          - libvirt
        append: true

    - name: Oh-My-Zsh installieren
      become: true
      become_user: "{{ user }}"
      shell: |
        if [ ! -d "{{ user_home }}/.oh-my-zsh" ]; then
          sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
        fi
      args:
        creates: "{{ user_home }}/.oh-my-zsh"

    # ══════════════════════════════════════════════════════════════
    # SSH-Härtung (base.nix)
    # ══════════════════════════════════════════════════════════════
    - name: SSH PasswordAuthentication deaktivieren
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PasswordAuthentication"
        line: "PasswordAuthentication no"
      notify: restart-sshd

    # ══════════════════════════════════════════════════════════════
    # Dotfiles Symlinks (home.nix home.file.*)
    # ══════════════════════════════════════════════════════════════
    - name: Dotfile-Verzeichnisse anlegen
      become: true
      become_user: "{{ user }}"
      file:
        path: "{{ user_home }}/{{ item.dest | dirname }}"
        state: directory
      loop: "{{ dotfile_links + blender_dotfile_links + styling_links + blender_extra_links }}"

    - name: Dotfiles symlinken
      become: true
      become_user: "{{ user }}"
      file:
        src: "{{ dot }}/{{ item.src }}"
        dest: "{{ user_home }}/{{ item.dest }}"
        state: link
        force: true
      loop: "{{ dotfile_links }}"

    - name: Blender-Dotfiles symlinken
      become: true
      become_user: "{{ user }}"
      file:
        src: "{{ dot }}/{{ item.src }}"
        dest: "{{ user_home }}/{{ item.dest }}"
        state: link
        force: true
      loop: "{{ blender_dotfile_links }}"

    - name: Styling/Theme-Dateien symlinken
      become: true
      become_user: "{{ user }}"
      file:
        src: "{{ styles }}/{{ item.src }}"
        dest: "{{ user_home }}/{{ item.dest }}"
        state: link
        force: true
      loop: "{{ styling_links }}"

    - name: Blender Theme + Addon symlinken
      become: true
      become_user: "{{ user }}"
      file:
        src: "{{ item.src }}"
        dest: "{{ user_home }}/{{ item.dest }}"
        state: link
        force: true
      loop: "{{ blender_extra_links }}"

    # ══════════════════════════════════════════════════════════════
    # Cursor-Theme (home.nix)
    # ══════════════════════════════════════════════════════════════
    - name: Cursor-Theme Verzeichnis anlegen
      become: true
      become_user: "{{ user }}"
      file:
        path: "{{ user_home }}/.icons/default"
        state: directory

    - name: Adwaita Cursor-Theme setzen
      become: true
      become_user: "{{ user }}"
      copy:
        dest: "{{ user_home }}/.icons/default/index.theme"
        content: |
          [Icon Theme]
          Inherits=Adwaita
        force: true

    # ══════════════════════════════════════════════════════════════
    # GNOME dconf Settings (home.nix dconf.settings)
    # ══════════════════════════════════════════════════════════════
    - name: GNOME Interface-Einstellungen setzen
      become: true
      become_user: "{{ user }}"
      community.general.dconf:
        key: "{{ item.key }}"
        value: "{{ item.value }}"
      loop:
        - { key: "/org/gnome/desktop/interface/gtk-theme", value: "'Gruvbox-Dark'" }
        - { key: "/org/gnome/desktop/interface/cursor-theme", value: "'Adwaita'" }
        - { key: "/org/gnome/desktop/interface/cursor-size", value: "24" }
        - { key: "/org/gnome/desktop/interface/text-scaling-factor", value: "1.0" }
        - { key: "/org/gnome/desktop/interface/enable-hot-corners", value: "true" }

    - name: GNOME Shell Extensions aktivieren
      become: true
      become_user: "{{ user }}"
      community.general.dconf:
        key: "/org/gnome/shell/enabled-extensions"
        value: "['user-theme@gnome-shell-extensions.gcampax.github.com', 'dash-to-dock@micxgx.gmail.com', 'appindicatorsupport@rgcjonas.gmail.com', 'mock-tray@kramo.page', 'gsconnect@andyholmes.github.io']"

    - name: GNOME Shell User-Theme setzen
      become: true
      become_user: "{{ user }}"
      community.general.dconf:
        key: "/org/gnome/shell/extensions/user-theme/name"
        value: "'Gruvbox-Dark'"

    - name: GNOME Favorite Apps setzen
      become: true
      become_user: "{{ user }}"
      community.general.dconf:
        key: "/org/gnome/shell/favorite-apps"
        value: "['brave-browser.desktop', 'firefox.desktop', 'thunderbird.desktop', 'slack.desktop', 'org.gnome.Nautilus.desktop', 'org.gnome.Settings.desktop', 'org.gnome.tweaks.desktop', 'obsidian.desktop', 'spotify.desktop', 'discord.desktop', 'pureref.desktop', 'org.godotengine.Godot4.4-mono.desktop', 'virt-manager.desktop', 'blender_blender.desktop', 'terminator.desktop', 'bruno.desktop', 'code.desktop', '1password.desktop']"

    - name: GNOME Fenster-Buttons (minimize, maximize, close)
      become: true
      become_user: "{{ user }}"
      community.general.dconf:
        key: "{{ item.key }}"
        value: "{{ item.value }}"
      loop:
        - { key: "/org/gnome/desktop/wm/preferences/button-layout", value: "'appmenu:minimize,maximize,close'" }
        - { key: "/org/gnome/desktop/wm/preferences/action-double-click-titlebar", value: "'toggle-maximize'" }
        - { key: "/org/gnome/desktop/wm/preferences/action-middle-click-titlebar", value: "'minimize'" }
        - { key: "/org/gnome/desktop/wm/preferences/mouse-button-modifier", value: "'<Super>'" }
        - { key: "/org/gnome/desktop/wm/preferences/resize-with-right-button", value: "true" }

    - name: GNOME Keybindings (Alt+Tab Fensterwechsel)
      become: true
      become_user: "{{ user }}"
      community.general.dconf:
        key: "{{ item.key }}"
        value: "{{ item.value }}"
      loop:
        - { key: "/org/gnome/desktop/wm/keybindings/switch-applications", value: "@as []" }
        - { key: "/org/gnome/desktop/wm/keybindings/switch-applications-backward", value: "@as []" }
        - { key: "/org/gnome/desktop/wm/keybindings/switch-windows", value: "['<Alt>Tab', '<Super>Tab']" }
        - { key: "/org/gnome/desktop/wm/keybindings/switch-windows-backward", value: "['<Shift><Alt>Tab', '<Shift><Super>Tab']" }

    - name: GNOME Shell Keybindings (Screenshot, Message-Tray)
      become: true
      become_user: "{{ user }}"
      community.general.dconf:
        key: "{{ item.key }}"
        value: "{{ item.value }}"
      loop:
        - { key: "/org/gnome/shell/keybindings/show-screenshot-ui", value: "['<Super><Shift>s']" }
        - { key: "/org/gnome/shell/keybindings/toggle-message-tray", value: "['<Super>m']" }

    - name: GNOME Custom Keybinding (Super+V für CopyQ)
      become: true
      become_user: "{{ user }}"
      community.general.dconf:
        key: "{{ item.key }}"
        value: "{{ item.value }}"
      loop:
        - { key: "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings", value: "['/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/']" }
        - { key: "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/binding", value: "'<Super>v'" }
        - { key: "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/command", value: "'env QT_QPA_PLATFORM=xcb GDK_BACKEND=x11 copyq show'" }
        - { key: "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/name", value: "'CopyQ - Clipboard Manager'" }

    - name: GNOME Wallpaper setzen
      become: true
      become_user: "{{ user }}"
      community.general.dconf:
        key: "{{ item.key }}"
        value: "{{ item.value }}"
      loop:
        - { key: "/org/gnome/desktop/background/picture-uri", value: "'file://{{ styles }}/Wallpapers/stairs.png'" }
        - { key: "/org/gnome/desktop/background/picture-uri-dark", value: "'file://{{ styles }}/Wallpapers/stairs.png'" }
        - { key: "/org/gnome/desktop/background/picture-options", value: "'zoom'" }

    - name: GNOME Mutter Einstellungen
      become: true
      become_user: "{{ user }}"
      community.general.dconf:
        key: "/org/gnome/mutter/experimental-features"
        value: "['scale-monitor-framebuffer']"

    - name: Dash-to-Dock Konfiguration
      become: true
      become_user: "{{ user }}"
      community.general.dconf:
        key: "{{ item.key }}"
        value: "{{ item.value }}"
      loop:
        - { key: "/org/gnome/shell/extensions/dash-to-dock/transparency-mode", value: "'FIXED'" }
        - { key: "/org/gnome/shell/extensions/dash-to-dock/custom-background-color", value: "true" }
        - { key: "/org/gnome/shell/extensions/dash-to-dock/background-color", value: "'#1d2021'" }
        - { key: "/org/gnome/shell/extensions/dash-to-dock/background-opacity", value: "1.0" }
        - { key: "/org/gnome/shell/extensions/dash-to-dock/dock-fixed", value: "false" }
        - { key: "/org/gnome/shell/extensions/dash-to-dock/autohide", value: "true" }
        - { key: "/org/gnome/shell/extensions/dash-to-dock/autohide-in-fullscreen", value: "true" }
        - { key: "/org/gnome/shell/extensions/dash-to-dock/intellihide", value: "false" }
        - { key: "/org/gnome/shell/extensions/dash-to-dock/hide-delay", value: "0.2" }
        - { key: "/org/gnome/shell/extensions/dash-to-dock/show-delay", value: "0.1" }
        - { key: "/org/gnome/shell/extensions/dash-to-dock/pressure-threshold", value: "100.0" }

    # ══════════════════════════════════════════════════════════════
    # Systemd User-Services (home.nix)
    # ══════════════════════════════════════════════════════════════
    - name: Systemd User-Service-Verzeichnis anlegen
      become: true
      become_user: "{{ user }}"
      file:
        path: "{{ user_home }}/.config/systemd/user"
        state: directory

    - name: CopyQ Autostart-Service erstellen
      become: true
      become_user: "{{ user }}"
      copy:
        dest: "{{ user_home }}/.config/systemd/user/copyq.service"
        content: |
          [Unit]
          Description=CopyQ clipboard manager
          After=graphical-session.target
          PartOf=graphical-session.target

          [Service]
          ExecStartPre=/usr/bin/sleep 3
          ExecStart=/usr/bin/env QT_QPA_PLATFORM=xcb GDK_BACKEND=x11 copyq
          Restart=on-failure
          RestartSec=3
          Environment=QT_QPA_PLATFORM=xcb
          Environment=GDK_BACKEND=x11

          [Install]
          WantedBy=graphical-session.target

    - name: MEGAsync Autostart-Service erstellen
      become: true
      become_user: "{{ user }}"
      copy:
        dest: "{{ user_home }}/.config/systemd/user/megasync.service"
        content: |
          [Unit]
          Description=MEGAsync automatic sync client
          After=graphical-session-pre.target
          PartOf=graphical-session.target

          [Service]
          ExecStart=/usr/bin/megasync
          Restart=on-failure
          RestartSec=3

          [Install]
          WantedBy=graphical-session.target

    - name: User-Services aktivieren
      become: true
      become_user: "{{ user }}"
      systemd:
        name: "{{ item }}"
        enabled: true
        scope: user
        daemon_reload: true
      loop:
        - copyq
        - megasync

    # ══════════════════════════════════════════════════════════════
    # PipeWire Low-Latency (desktop.nix)
    # ══════════════════════════════════════════════════════════════
    - name: PipeWire Low-Latency Config erstellen
      copy:
        dest: /etc/pipewire/pipewire.conf.d/92-low-latency.conf
        content: |
          context.properties = {
              default.clock.rate          = 48000
              default.clock.quantum       = 512
              default.clock.min-quantum   = 512
              default.clock.max-quantum   = 512
          }

    # ══════════════════════════════════════════════════════════════
    # Services aktivieren
    # ══════════════════════════════════════════════════════════════
    - name: NetworkManager aktivieren
      systemd:
        name: NetworkManager
        enabled: true
        state: started

    - name: SSH aktivieren
      systemd:
        name: "{{ (ansible_os_family == 'Debian') | ternary('ssh', 'sshd') }}"
        enabled: true
        state: started

    - name: Firewall aktivieren (Arch/Fedora)
      systemd:
        name: firewalld
        enabled: true
        state: started
      when: ansible_os_family != "Debian"

    - name: UFW aktivieren (Debian)
      ufw:
        state: enabled
        policy: deny
      when: ansible_os_family == "Debian"

    - name: GDM aktivieren
      systemd:
        name: gdm
        enabled: true

    - name: Docker aktivieren
      systemd:
        name: docker
        enabled: true
        state: started

    - name: Docker Auto-Prune Timer erstellen
      copy:
        dest: /etc/systemd/system/docker-prune.timer
        content: |
          [Unit]
          Description=Weekly Docker System Prune

          [Timer]
          OnCalendar=weekly
          Persistent=true

          [Install]
          WantedBy=timers.target

    - name: Docker Auto-Prune Service erstellen
      copy:
        dest: /etc/systemd/system/docker-prune.service
        content: |
          [Unit]
          Description=Docker System Prune
          Requires=docker.service
          After=docker.service

          [Service]
          Type=oneshot
          ExecStart=/usr/bin/docker system prune --all --force

    - name: Docker Auto-Prune Timer aktivieren
      systemd:
        name: docker-prune.timer
        enabled: true
        state: started
        daemon_reload: true

    - name: CUPS aktivieren
      systemd:
        name: cups
        enabled: true
        state: started

    - name: Avahi aktivieren
      systemd:
        name: avahi-daemon
        enabled: true
        state: started

    - name: Bluetooth aktivieren
      systemd:
        name: bluetooth
        enabled: true
        state: started

    - name: Libvirtd aktivieren
      systemd:
        name: libvirtd
        enabled: true
        state: started

    - name: I2P aktivieren
      systemd:
        name: i2pd
        enabled: true
        state: started

    - name: Thermald aktivieren
      systemd:
        name: thermald
        enabled: true
        state: started
      ignore_errors: true

    - name: ClamAV Virendefinitionen aktualisieren
      command: freshclam
      changed_when: false
      ignore_errors: true

    - name: ClamAV aktivieren
      systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - clamav-daemon
        - clamav-freshclam

    - name: Syncthing User-Service aktivieren
      become: true
      become_user: "{{ user }}"
      systemd:
        name: syncthing
        enabled: true
        scope: user

    # ══════════════════════════════════════════════════════════════
    # Firewall-Ports (gnome.nix + gaming.nix + users/mauschel.nix)
    # ══════════════════════════════════════════════════════════════
    - name: Firewall-Ports öffnen (firewalld)
      firewalld:
        port: "{{ item }}"
        permanent: true
        state: enabled
      loop:
        # GSConnect (gnome.nix)
        - 1716-1764/tcp
        - 1716-1764/udp
        # Steam (gaming.nix)
        - 27015-27030/tcp
        - 27000-27100/udp
        - 27036-27037/tcp
        - 4380/udp
        # Spotify (users/mauschel.nix)
        - 57621/tcp
        # AusweisApp
        - 24727/tcp
        - 24727/udp
        # LocalSend
        - 53317/tcp
        - 53317/udp
        # mDNS
        - 5353/udp
      when: ansible_os_family != "Debian"
      notify: reload-firewalld

    - name: UFW-Ports öffnen (Debian)
      ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop:
        - { port: "1716:1764", proto: tcp }
        - { port: "1716:1764", proto: udp }
        - { port: "27015:27037", proto: tcp }
        - { port: "27000:27100", proto: udp }
        - { port: "4380", proto: udp }
        - { port: "57621", proto: tcp }
        - { port: "24727", proto: tcp }
        - { port: "24727", proto: udp }
        - { port: "53317", proto: tcp }
        - { port: "53317", proto: udp }
        - { port: "5353", proto: udp }
      when: ansible_os_family == "Debian"

    # ══════════════════════════════════════════════════════════════
    # Gaming-Tweaks (gaming.nix)
    # ══════════════════════════════════════════════════════════════
    - name: Controller udev-Regeln erstellen
      copy:
        dest: /etc/udev/rules.d/99-gaming-controllers.rules
        content: |
          # Nintendo Switch Pro Controller
          KERNEL=="hidraw*", ATTRS{idVendor}=="057e", ATTRS{idProduct}=="2009", MODE="0666"
          # PlayStation Controller
          KERNEL=="hidraw*", ATTRS{idVendor}=="054c", MODE="0666"
          # 8BitDo Controller
          KERNEL=="hidraw*", ATTRS{idVendor}=="2dc8", MODE="0666"
          # Steam Controller
          KERNEL=="hidraw*", ATTRS{idVendor}=="28de", MODE="0666"
      notify: reload-udev

    - name: memlock-Limits für Gaming erhöhen
      copy:
        dest: /etc/security/limits.d/99-gaming.conf
        content: |
          @users soft memlock unlimited
          @users hard memlock unlimited

    # ══════════════════════════════════════════════════════════════
    # AUR-Pakete (nur Arch/CachyOS)
    # ══════════════════════════════════════════════════════════════
    - name: AUR-Pakete installieren (via paru)
      become: true
      become_user: "{{ user }}"
      command: "paru -S --noconfirm --needed {{ item }}"
      loop:
        - asusctl
        - supergfxctl
        - rog-control-center
        - spotify-player
        - lazydocker
        - pureref
        - bun-bin
        - networkmanager-dmenu-git
        - gnome-shell-extension-blur-my-shell
        - gnome-shell-extension-mock-tray
        - gtk-engine-murrine
        - pcsx2
        - ttf-ms-fonts
        - gnome-shell-extension-gsconnect
      changed_when: false
      when: ansible_os_family == "Archlinux"

    - name: asusctl Services aktivieren
      systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - asusd
        - supergfxd
      ignore_errors: true

  # ══════════════════════════════════════════════════════════════
  # Handlers
  # ══════════════════════════════════════════════════════════════
  handlers:
    - name: restart-sshd
      systemd:
        name: "{{ (ansible_os_family == 'Debian') | ternary('ssh', 'sshd') }}"
        state: restarted

    - name: reload-firewalld
      command: firewall-cmd --reload
      when: ansible_os_family != "Debian"

    - name: reload-udev
      command: udevadm control --reload-rules && udevadm trigger
